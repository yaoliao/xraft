### Raft å®žçŽ°

ç…§ç€ [åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•å¼€å‘å®žæˆ˜](https://book.douban.com/subject/35051108/) è¿™æœ¬ä¹¦æ•²ä¸€é

ä¹¦ä¸­åŽŸæ¥çš„å®žçŽ° [github](https://github.com/xnnyygn/xraft)

[raft è®ºæ–‡ç¿»è¯‘](https://github.com/maemual/raft-zh_cn)

### è®°å½•ä¸€ä¸‹

1. ä¸ºä»€ä¹ˆæ–° leader é€‰ä¸¾å‡ºæ¥ä¹‹åŽéœ€è¦åˆ›å»ºä¸€æ¡ç©ºæ—¥å¿—ï¼ˆNoopï¼‰ï¼Ÿ

> è¿™æ˜¯å› ä¸º leader åªèƒ½ commit å½“å‰ä»»æœŸçš„æ—¥å¿—ï¼Œä¸èƒ½æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ã€‚
> å¦‚æžœä¸æäº¤ç©ºæ—¥å¿—ï¼Œå°±å¯èƒ½äº§ç”Ÿè¿™æ ·ä¸€ç§æƒ…å†µï¼šå®¢æˆ·ç«¯ä¸€ç›´æœªå‘é€æ—¥å¿—è¿‡æ¥ï¼Œ leader å°±ä¸€ç›´ä¸äº§ç”Ÿå½“å‰ä»»æœŸçš„æ—¥å¿—ï¼Œå¯¼è‡´ä¹‹å‰ä»»æœŸäº§ç”Ÿçš„æ—¥å¿—ä¼šä¸€ç›´æ— æ³•è¢«æäº¤ã€‚
> æ‰€ä»¥ï¼Œå½“æ–° leader é€‰ä¸¾æˆåŠŸä¹‹åŽï¼Œå…ˆåœ¨æäº¤ä¸€ä¸ªå½“å‰ä»»æœŸçš„ç©ºæ—¥å¿—ï¼Œä»¥æ­¤æ¥ä¿è¯ä¹‹å‰çš„æ—¥å¿—éƒ½å¯ä»¥è¢« commit

2. æ—¥å¿—å¿«ç…§ä¸­çš„æ•°æ®éƒ½æ˜¯å·²ç»è¢«çŠ¶æ€æœºåº”ç”¨è¿‡çš„ï¼ˆappliedï¼‰

> raft è®ºæ–‡: the last included index is the index of the last entry in the log that the snapshot replaces (the last en- try the state machine had applied)

3. rafté›†ç¾¤æˆå‘˜å˜æ›´æœ‰ä¸¤ç§æ–¹æ³•
    * è”åˆå…±è¯†ï¼šå°†å˜æ›´åˆ†ä¸ºä¸¤é˜¶æ®µï¼Œå…ˆåº”ç”¨ C(old,new) å†åº”ç”¨ C(new)ã€‚å®žçŽ°å¤æ‚
    * å•èŠ‚ç‚¹å˜æ›´ï¼šä¸€æ¬¡åªèƒ½å˜æ›´ä¸€ä¸ªèŠ‚ç‚¹ã€‚å®žçŽ°ç®€å•ï¼ŒåŸºæœ¬ä¸Šéƒ½ç”¨è¿™ç§æ–¹å¼

> å•èŠ‚ç‚¹å˜æ›´è§„åˆ™ (ä¹¦ä¸­ 10.1.2 å°ç»“)ï¼š
>1. æ–°é›†ç¾¤é…ç½®æ˜¯ä¸€æ¡æ—¥å¿—
>2. èŠ‚ç‚¹æ”¶åˆ°æ–°çš„é…ç½®ç«‹å³åº”ç”¨ï¼Œä¸ç”¨ç­‰åˆ°å¯¹åº”çš„æ—¥å¿—è¢«æäº¤
>3. æ–°é›†ç¾¤é…ç½®åªå‘é€ç»™æ–°é›†ç¾¤é…ç½®ä¸­çš„æˆå‘˜ï¼Œä¸ä¼šå‘é€ç»™è¢«ç§»é™¤çš„èŠ‚ç‚¹
>4. æ”¶åˆ°æ¥è‡ªä¸å±žäºŽè‡ªå·±é›†ç¾¤é…ç½®çš„ RequestVote æ¶ˆæ¯æ—¶ï¼ŒæŒ‰ç…§åŽŸæœ‰æ–¹æ³•æ¯”è¾ƒæ—¥å¿—åŽå†³å®šæ˜¯å¦æŠ•ç¥¨
>5. æ”¶åˆ°æ¥è‡ªä¸å±žäºŽè‡ªå·±é›†ç¾¤é…ç½®çš„ AppendEntries æ¶ˆæ¯æ—¶ï¼ŒæŒ‰ç…§åŽŸæœ‰çš„æ–¹æ³•æ‰§è¡Œ

> [å¤§ä½¬å¯¹å•èŠ‚ç‚¹å˜æ›´çš„è¯´æ˜Ž](https://blog.openacid.com/distributed/raft-bug/)   æ²¡çœ‹æ‡‚ã€‚ã€‚ ðŸ˜‚

4. é›†ç¾¤æˆå‘˜å˜æ›´æ—¶ï¼Œè¢«ç§»é™¤çš„æˆå‘˜å› ä¸ºä¸ä¼šå†æ”¶åˆ°å¿ƒè·³ä¿¡æ¯ï¼Œä¼šé€‰ä¸¾è¶…æ—¶è€Œå‘èµ·é€‰ä¸¾æŠ•ç¥¨ï¼Œè¿™æ—¶å€™ leader å¯èƒ½å› ä¸ºè¯¥èŠ‚ç‚¹çš„å½±å“ï¼Œè€Œé€€åŒ–ä¸º followerã€‚ä½¿å¾—é›†ç¾¤çŸ­æš‚çš„ä¸å¯ç”¨ã€‚ ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œå¯ä»¥åŠ å…¥ preVote æœºåˆ¶ï¼Œå¹¶ä¸”
   follower åªæœ‰åœ¨æœ€å°é€‰ä¸¾é—´éš”å†…ä¸æŽ¥å— requestVote çš„æ¶ˆæ¯ã€‚ï¼ˆä¹¦ä¸­ 10.2.3 èŠ‚ï¼‰


5. raft ä¼˜åŒ–æ–¹å¼
    * è¯»è¯·æ±‚ä¼˜åŒ–ä½¿ç”¨ readIndex çš„æ–¹å¼ï¼šå½“ leader æŽ¥æ”¶åˆ°ä¸€ä¸ªè¯»è¯·æ±‚ï¼Œè®°å½•å½“å‰çš„ commitIndex ä¸º readIndexï¼Œç„¶åŽç­‰ leader çš„ applyIndex >= readIndex
      çš„æ—¶å€™ï¼Œæ‰§è¡Œè¯»æ“ä½œï¼Œè¿”å›žå®¢æˆ·ç«¯
    * pipeliningï¼šå°†æ—¥å¿—å¤åˆ¶è¯·æ±‚è¿žç»­å‘é€ï¼Œè€Œä¸æ˜¯ç­‰å¾…å‰ä¸€ä¸ªè¯·æ±‚è¿”å›žä¹‹åŽå†å‘èµ·åŽä¸€ä¸ªè¯·æ±‚
   
>  [tikv å¯¹ raft çš„ä¼˜åŒ–](https://pingcap.com/zh/blog/optimizing-raft-in-tikv)